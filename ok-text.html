<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<title>OK â†’ æˆ‘æ˜¯ç™½ä¹Ÿï¼ˆç¨³å®šç‰ˆï¼‰</title>
<style>
html,body{
  margin:0;
  overflow:hidden;
  background:#000;
}
canvas{display:block}
</style>
</head>
<body>

<video id="video" style="display:none"></video>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/@mediapipe/hands/hands.js"></script>
<script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ===================== Three ===================== */
const scene = new THREE.Scene()
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100)
camera.position.z = 4

const renderer = new THREE.WebGLRenderer({antialias:true})
renderer.setSize(innerWidth, innerHeight)
renderer.setPixelRatio(devicePixelRatio)
document.body.appendChild(renderer.domElement)

/* ===================== ç²’å­ ===================== */
const COUNT = 6000
const pos = new Float32Array(COUNT*3)
const vel = new Float32Array(COUNT*3)
const acc = new Float32Array(COUNT*3)

for(let i=0;i<COUNT;i++){
  pos[i*3]=(Math.random()-0.5)*3
  pos[i*3+1]=(Math.random()-0.5)*3
  pos[i*3+2]=(Math.random()-0.5)*3

  // ğŸ”‘ å…³é”®ï¼šåˆå§‹ acc = åˆå§‹ posï¼ˆé˜²æ­¢å¡Œç¼©ï¼‰
  acc[i*3]   = pos[i*3]
  acc[i*3+1] = pos[i*3+1]
  acc[i*3+2] = pos[i*3+2]
}

const geo = new THREE.BufferGeometry()
geo.setAttribute('position', new THREE.BufferAttribute(pos,3))
const mat = new THREE.PointsMaterial({
  color:0x00ffff,
  size:0.02,
  transparent:true,
  opacity:0.9
})
const particles = new THREE.Points(geo, mat)
scene.add(particles)

/* ===================== æ–‡å­—å½¢æ€ ===================== */
function shapeText(){
  const c = document.createElement('canvas')
  c.width = 512
  c.height = 256
  const g = c.getContext('2d')

  g.clearRect(0,0,512,256)
  g.fillStyle = '#0ff'
  g.font = 'bold 96px sans-serif'
  g.textAlign = 'center'
  g.textBaseline = 'middle'
  g.fillText('æˆ‘æ˜¯ç™½ä¹Ÿ', 256, 128)

  const data = g.getImageData(0,0,512,256).data
  let pts = []

  for(let y=0;y<256;y+=3){
    for(let x=0;x<512;x+=3){
      if(data[(y*512+x)*4+3] > 0){
        pts.push({
          x:(x/512-0.5)*3,
          y:(0.5-y/256)*2
        })
      }
    }
  }

  for(let i=0;i<COUNT;i++){
    if(i < pts.length){
      acc[i*3]   = pts[i].x
      acc[i*3+1] = pts[i].y
      acc[i*3+2] = 0
    }
  }
}

/* ===================== MediaPipe OK ===================== */
let stable = 0
let triggered = false
const STABLE_FRAMES = 6

const hands = new Hands({
  locateFile:f=>`https://unpkg.com/@mediapipe/hands/${f}`
})
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
})

hands.onResults(res=>{
  if(!res.multiHandLandmarks){
    stable = 0
    triggered = false
    return
  }

  const lm = res.multiHandLandmarks[0]

  const ok =
    Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y) < 0.05 &&
    lm[12].y > lm[10].y &&
    lm[16].y > lm[14].y &&
    lm[20].y > lm[18].y

  if(ok){
    stable++
  }else{
    stable = 0
    triggered = false
  }

  if(stable > STABLE_FRAMES && !triggered){
    triggered = true
    shapeText()
  }
})

const cam = new Camera(document.getElementById('video'),{
  onFrame: async ()=>{ await hands.send({image:video}) },
  width:640,
  height:480
})
cam.start()

/* ===================== åŠ¨ç”» ===================== */
function animate(){
  requestAnimationFrame(animate)

  for(let i=0;i<COUNT;i++){
    vel[i*3]   += (acc[i*3]   - pos[i*3])   * 0.04
    vel[i*3+1] += (acc[i*3+1] - pos[i*3+1]) * 0.04
    vel[i*3+2] += (acc[i*3+2] - pos[i*3+2]) * 0.04

    vel[i*3]   *= 0.85
    vel[i*3+1] *= 0.85
    vel[i*3+2] *= 0.85

    pos[i*3]   += vel[i*3]
    pos[i*3+1] += vel[i*3+1]
    pos[i*3+2] += vel[i*3+2]
  }

  geo.attributes.position.needsUpdate = true
  renderer.render(scene, camera)
}
animate()

window.onresize=()=>{
  camera.aspect = innerWidth/innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize(innerWidth,innerHeight)
}
</script>
</body>
</html>